# FitLoop システムアーキテクチャ設計書

## 1. システム概要

FitLoopは、ユーザーの筋トレデータと個人情報を管理し、AI（Claude、ChatGPT、Gemini等）との連携を通じて最適なプロンプトを提供するシステムです。

### 1.1 システムの目的
- ユーザーの好み、欲求、気持ちを尊重したコンテキスト管理
- 異なるAIセッション間でのユーザー状態の共有
- ユーザーが必要とする最適なプロンプトの提供
- データインポート/エクスポートの簡易化

### 1.2 設計原則
- **ユーザー主導**: AIが提案するのではなく、ユーザーが必要とするものを提供
- **シンプルさ**: コマンドライン操作での高い操作性
- **コスト効率**: サーバーレスアーキテクチャによる低コスト運用
- **拡張性**: 将来的な機能追加を考慮した設計

## 2. システムアーキテクチャ

### 2.1 全体構成

```
┌─────────────────────────────────────────────────────────────┐
│                        ユーザー端末                            │
├─────────────────────────────────────────────────────────────┤
│  Claude Code CLI  │  ChatGPT  │  Claude  │  Gemini  │  他    │
└────────┬──────────┴───────────┴──────────┴──────────┴────────┘
         │
         │ HTTPS (REST API)
         │
┌────────▼────────────────────────────────────────────────────┐
│                     API Gateway                              │
│              (Cloudflare Workers / AWS API Gateway)          │
└────────┬────────────────────────────────────────────────────┘
         │
┌────────▼────────────────────────────────────────────────────┐
│                  サーバーレス関数層                           │
│         (Cloudflare Workers / AWS Lambda Functions)          │
├──────────────────────────────────────────────────────────────┤
│  ・ユーザー認証/認可                                          │
│  ・コンテキスト管理                                          │
│  ・プロンプト生成                                            │
│  ・データインポート/エクスポート                              │
└────────┬────────────────────────────────────────────────────┘
         │
┌────────▼────────────────────────────────────────────────────┐
│                    データストレージ層                         │
├──────────────────────────────────────────────────────────────┤
│  KV Store (Cloudflare KV / DynamoDB)  │  Object Storage      │
│  ・ユーザー情報                       │  (R2 / S3)          │
│  ・セッション状態                     │  ・画像データ        │
│  ・プロンプトテンプレート             │  ・大容量データ      │
└──────────────────────────────────────────────────────────────┘
```

### 2.2 コンポーネント詳細

#### 2.2.1 API Gateway
- **役割**: リクエストのルーティング、レート制限、CORS処理
- **認証**: APIキーベース認証（初期版）、JWT（将来的）

#### 2.2.2 サーバーレス関数
主要な関数：
1. **UserContextFunction**: ユーザーコンテキストの管理
2. **PromptGeneratorFunction**: 最適なプロンプトの生成
3. **DataImportFunction**: 外部データのインポート処理
4. **DataExportFunction**: データのエクスポート処理

#### 2.2.3 データストレージ
- **KVストア**: 高速アクセスが必要なユーザー情報とセッション状態
- **オブジェクトストレージ**: 画像データや大容量のトレーニングログ

## 3. デプロイメント比較: Cloudflare Workers vs AWS Lambda

### 3.1 Cloudflare Workers

**メリット:**
- ✅ **超低レイテンシ**: エッジコンピューティングで世界中で高速
- ✅ **コスト効率**: 無料枠が寛大（10万リクエスト/日）
- ✅ **シンプルな料金体系**: リクエスト数ベースの課金
- ✅ **グローバル展開が容易**: 自動的に世界中にデプロイ
- ✅ **Cloudflare KVとの統合**: 低レイテンシのKVストア
- ✅ **Wrangler CLI**: 優れた開発体験

**デメリット:**
- ❌ CPU時間制限: 10ms（無料）/ 50ms（有料）
- ❌ メモリ制限: 128MB
- ❌ 実行時間制限: 最大30秒
- ❌ Node.js互換性: 完全ではない

**料金:**
```
無料プラン:
- 10万リクエスト/日
- 10ms CPU時間/リクエスト

有料プラン($5/月):
- 1000万リクエスト/月 込み
- 追加: $0.50/100万リクエスト
- 50ms CPU時間/リクエスト
```

### 3.2 AWS Lambda

**メリット:**
- ✅ **豊富な実行時間**: 最大15分
- ✅ **大容量メモリ**: 最大10GB
- ✅ **完全なNode.js互換性**
- ✅ **AWSエコシステムとの統合**: DynamoDB、S3等
- ✅ **成熟したツールチェーン**: SAM、Serverless Framework

**デメリット:**
- ❌ コールドスタート問題
- ❌ 複雑な料金体系
- ❌ リージョン依存のレイテンシ
- ❌ 設定が複雑

**料金:**
```
無料枠:
- 100万リクエスト/月
- 40万GB秒の実行時間

有料:
- $0.20/100万リクエスト
- $0.0000166667/GB秒
```

### 3.3 推奨: Cloudflare Workers

**理由:**
1. **FitLoopの要件に最適**: 短時間の処理が中心
2. **コスト効率**: 無料枠で十分な規模まで対応可能
3. **開発速度**: Wrangler CLIでClaude Codeから直接デプロイ可能
4. **グローバル対応**: 世界中のユーザーに低レイテンシで提供

## 4. API仕様

### 4.1 エンドポイント一覧

```yaml
BASE_URL: https://api.fitloop.app/v1

endpoints:
  # ユーザーコンテキスト管理
  - path: /context
    methods:
      GET: ユーザーコンテキスト取得
      POST: コンテキスト作成/更新
      DELETE: コンテキスト削除
    
  # プロンプト生成
  - path: /prompt/generate
    method: POST
    description: 現在のコンテキストに基づくプロンプト生成
    
  # データインポート
  - path: /import
    method: POST
    description: 外部データのインポート（画像解析含む）
    
  # データエクスポート  
  - path: /export
    method: GET
    description: ユーザーデータのエクスポート
    
  # セッション管理
  - path: /session
    methods:
      POST: 新規セッション開始
      GET: アクティブセッション取得
      PUT: セッション更新
```

### 4.2 認証

初期版: APIキー認証
```
Authorization: Bearer YOUR_API_KEY
```

### 4.3 レスポンス形式

```json
{
  "success": true,
  "data": {
    // レスポンスデータ
  },
  "error": null,
  "timestamp": "2025-05-30T12:00:00Z"
}
```

## 5. セキュリティ設計

### 5.1 データ保護
- 通信: HTTPS必須
- 保存時: 暗号化（Cloudflare KVは自動暗号化）
- APIキー: ハッシュ化して保存

### 5.2 アクセス制御
- レート制限: 1分間に60リクエスト/ユーザー
- CORS設定: 許可されたオリジンのみ
- APIキーのローテーション機能

## 6. 開発・デプロイ手順

### 6.1 Cloudflare Workers セットアップ

```bash
# Wrangler CLIインストール
npm install -g wrangler

# プロジェクト初期化
wrangler init fitloop-api

# 開発サーバー起動
wrangler dev

# デプロイ
wrangler publish
```

### 6.2 環境変数設定

```toml
# wrangler.toml
name = "fitloop-api"
type = "javascript"
account_id = "YOUR_ACCOUNT_ID"

[env.production]
vars = { ENVIRONMENT = "production" }
kv_namespaces = [
  { binding = "USERS", id = "YOUR_KV_ID" }
]
```

## 7. 拡張性と将来の機能

### 7.1 計画中の機能
- WebSocket対応（リアルタイム更新）
- 音声入力対応
- 複数言語サポート
- プロンプトマーケットプレイス

### 7.2 スケーラビリティ
- Cloudflare Workersの自動スケーリング
- KVストアの無制限容量
- 必要に応じてDurable Objectsへの移行

## 8. モニタリングとログ

### 8.1 Cloudflare Analytics
- リクエスト数、エラー率の監視
- レイテンシ分析
- 地理的分布

### 8.2 カスタムログ
- 構造化ログ（JSON形式）
- エラートラッキング
- ユーザー行動分析（プライバシー配慮）